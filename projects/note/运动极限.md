# [GUI] 建立轮胎模型
检查在多少个静态载荷可以达到SLIP峰值

路面附着f应该选择较大的，这样可以使得需要的载荷Fz较小

Sx_peak目前是猜测的，但是实际上应该可以通过vx-ax-sx表进行获取

C * Sx_peak = Fz * f(temp)
Tyre(Sx_peak) = Fz * f(temp)
Fz = Tyre(Sx_peak) / f(temp) 
k = Fz / Fz_static

该问题的解答：
轮胎模型魔术公式的形式如下，一些项可以整合为mu_tire(Fz, sx)
Fx = Fz * mu_tire(Fz, sx)
实际上Fx还受到路面附着影响
Fx_max = Fz * f
所以综合而言,轮胎纵侧向力同时受到自身特性和路面特性的限制
Fx_max = Fz * min(f, mu_tire(Fz, sx))

但是sx并不受到f的影响，也不受到Fz的影响

以上发现内容已在dev/dynamics_monitor_debug中进行了修改

# [GGV] 在tools中开发

1. 绘制vx-ax-sx / vx-yaw_rate-sy 的三维图
2. 数据采集最好有一个数据百分比，确定已完成数据采集，各个方向的加速度都有，各个方向都触发极限标识
极限标识：
纵向极限标识
侧向极限标识

if there safe method in motion control:
    the desired acc can not be reach
else:
    the desired acc can not be reach.
    the slip will over the peak. 
    collision

如果可以的画通过gui显示出来
1. 采集赛道仿真1圈的数据，基于高分位回归和单调进行单次拟合

# 20251002 
目前已经完成了上述内容中已完成功能：
* 绘制vx-ax-sx / vx-ay-sy 的三维图
* 轮胎特性的绘制
* 发动机极限的判定

接下来的开发项
* 轮胎侧偏特性，以及轮胎模型绘制整合为一个弹窗。并增加对不同速度下的vx-sxsy极限的绘制，不同压力下轮胎摩擦椭圆的变化。同时完成tire limit函数
->slip弹窗可以修改是否通过低通滤波（滑移不是瞬间产生的，需要一个很小的延迟，但是这里我们的resample时间间隔过可能无法获得有效数据），还可以选择拟合函数，函数应该在不同速度下都是以原点为拐点的S型曲线

* 查看抓地力分析模块，建立自己的路面极限轮胎力估计功能
->Ali所实现的是基于统计方法的版本，只适用于有不同辅助车辆运动状态先验的情况

* 完成离线的极限分析功能，集成发动机极限、轮胎极限以及ABS、ESC极限识别。ABS通过slip判断，ESC通过模型与实车的残差实现。

* 轮胎极限的判定需要不同速度slip函数，以及当前的附着情况（可以基于胎温判断）
  
* 还需要一个对模型匹配进行检查的模块，以检测各个模块参数是否与真实车辆匹配（同时也相当于ESC极限判断）

* 高分位回归还没有完成，目前是希望采集剔除了ax_drag的干净包络，但是ax_drag的准确值不好判断，可以考虑对其进行完整拟合

vx-ax-sx拟合函数的特点：
1. 原点处为0
2. 原点为拐点

# 20251003
目前的进展：
* 轮胎侧偏特性，以及轮胎模型绘制已经整合为一个弹窗
* 完成了limit analyse的初步开发，需要进一步细化 
下一步工作：
1. 需要进一步用steer_fb代替steer_cmd获得更加准确的slip angle，对离线和在线功能进行修正，同时检查在线slip估计中静止状态下的bug，同时需要给轮速加一个lpf延迟，而不是给最终的slip添加延迟。目前在加速时，前轮没有动力但是会有滑转，这是由于轮速估计与车速有相位差导致的。
最好可以计算每个速度下的Cf和Cr参考值（但是目前没有很好的用处）

2. limit analyse的最终完善，并将功能与UI进行剥离，可以选择放在util中。
需要明确有哪些超参数，应该包括：mu_th engine_u_th ABS_u_th ESC_u_th，ESC的判断形式可能需要调整，最好是有一个置信带，超出置信带之后再用数值判断，但是目前也不适合太复杂。
所以额外的参数应该包括 ABS的delta_acc_th sx_th，ESC的yaw_rate_diff_th,这几个值应该是公认合理的，且不应该经常改变
尽可能全的绘图（每个判据的的得分和旗帜，最好不要根据q调整，而是clip到q）
侧纵横摆可视化-主要是为了看菱形
覆盖度分析

3. 高分位ggv回归一定要纯数据模型，不要依赖于模型参数，因为模型参数本身就是猜测的。这样采集比较灵活，用起来也比较简单。
# 20251004
目前的进展：
- 已完成对dynamics monitor中车辆action bug的修复，是由于car_tel进行了*100二次处理造成的，对应20251003工作1，在仿真中尝试了添加wheel speed延迟效果不好，需要仅在实车运行时进行测试

- 剥离了部分功能，但是主体功能还需要使用时进行选择，不适合目前剥离，需要进一步完善成熟
  增加了更丰富的绘图，包括lon-lat-yaw（验证了ACORN理论模型），以及每个limit检测的score和flag，将极限超参进行了统一整理-
  讨论：
  但是目前各个评估项的超参之间没有联系，后面可能需要通过分位判断，来设置统一的极限。是否这样处理都可以。如果这样处理可能会造成后面每次都会按照做分位的形状进行探索，但是也不一定。分位统一，可以放在action中。

待完成工作：
- 覆盖度分析，百分比
- 阈值分位统一
- 探索置信方向分析，形式可以为各个方向的概率。（数据足够多且相比远离极限）
- 高分位回归，纯数据模型

- 加入侧向误差绘制
记得录实车运行视频

# 20251005
目前的进展：
- 加入侧向误差绘制
- 覆盖度分析，百分比,可以绘制速度、加速度极限直方图，以及不同速度和采样方向的极限比例三维图
接下来应该基于这些信息确定探索的置信以及方向
-完美实现了基于分位的阈值标定，但是发现并已经修正了ABS limit出现的位置不对（出现在了加速位置）

待完成工作：
- 探索置信方向分析，形式可以为各个方向的概率。（数据足够多且相比远离极限）
输出应该是不同速度各个方向gg的步长，应该按照速度划分吗？一个速度以下全部采集完整之后再提升速度这样应该比较合理。

- 高分位回归，纯数据模型
开始方法的仿真验证

讨论：
如果没有最高车速限制，应该往哪个方向探索？
- 安全余度比较大的方向、也就是hybrid_utilization的高分位（例如80～90%）比较小的方向（有的区域没有数据可以使用周围的数据进行替代，或者滤波，确保每个方向都有值可以用）
- 确定性比较高的方向，在极限内的确定性比较高，confidence比较高
direction and step

如果数据特别少的阶段，应该哪个方向数据少去哪个方向，以采集该方向更多的数据（但是不是探索而是为了采集数据，然而所采集数据的分布通常受到赛道限制无法改变，所以该条可能要放弃）
但是速度数据是我们可控的，所以关于速度可以启用这条
哪个速度的ggv数据较少

数据少的区域用模型的能力进行弥补，类似卡尔曼滤波，模型是一个参考

gg更新和速度更新之间是什么关系呢？

# 20251006
确定高分位回归形式->置信方案

# 20251009
- 高分位回归，完成c_acc c_dec的回归，通过耦合区域的ax ay进行c的反算然后获得分布后再进行回归
- 包络绘图，添加一个勾选是否保留数据点

- 还需要对dynamics monitor进行升级，目前存在ay以及sx不稳定的情况，需要接入低通滤波器
车辆动作最好加入百分比描述，直接将cmd->fb panel集成进来
打通播包显示

关于包络置信->
足够的行驶数据越多置信度越高
包络上状态点，先验极限利用率较低，置信度越高
两个需要进行归一化，然后再组成一个联合分布
每个速度循环分别执行

# 20251010
- **[upgrade][ok] limit analyse 零相位滤波**
离线极限分析的ay ax进行零相位滤波，将滤波参数选择添加到gui，仅仅会影响幅值不会造成时延

- **[debug][pending] 实车的轮胎地面关系识别**
通过观察应该是没有滤波的问题
动力学分析中，slip数值均为0,需要修改变量名
可以参考一下，控制模块的vx-ax-sx曲面。
绘制了vx-ax-sx数据，是一个ax->ax的map，用于制动过程，特点是sx过大的时候会降低ax达到ABS的效果，看起来比较像是某个求解器遍历求解的结果。所获取的ax直接乘以brakepressure2force作为输出

零相位低通滤波，时间常数为0.1可以得到一个合理的轮胎侧偏特性，滑移特性通过真实车辆数据比较难以获取
暂时关闭，需要时可以打开

- **[upgrade][doing] GUI dynamics monitor升级**
1. 还需要对dynamics monitor进行升级，目前存在ay以及sx不稳定的情况，需要接入低通滤波器,already but need to integrated up.最好也是可以动态配置的，目前ax vx比较准确，syf，syr有参考值
目前的简单实现也是可以的，但是最好引用文件filter。

# 20251012
- **[upgrade][ok] 先验加权高分位回归**
在实车数据中，有的位置虽然数据比较多，但是limit先验比较大，应该进行加权降低这部分的比重。或者直接舍弃数据量作为分位依据，而是应该limit先验为主，数量为辅组成分位依据
主要是为了剔除掉limit utilization较大的数据

已经完成，可以稍微减小保罗，但是不同速度的连续性有些不好，可能需要加入不同速度之间变化率的限制 delta ax_max / delta vx (m/s^2) / (m/s),应该从置信最高的速度开始
mustafa方案是使用二次函数来拟合，或许是一个简洁有效的方法

ax = k0 + k1 * vx + k2 * vx^2 
ax = ax0 + k2 * vx^2

使用二次函数之后获得的包络连续性非常好,其中还考虑了对应速度数据数量的影响,只信任数据数量高于中位数的工况数据,使用这部分速度下数据的分位进行拟合

数据量累积比较大,limit_u比较小,区域乘以一个增益,并在线检测limit表征,如果触发limit报警或者发生事故则进行回退,否则采集数据进行新的标定,新的标定将会使得包络扩展.
初始值的获取是通过理论模型推导获得的,并且需要乘以一个比较保守的参数

获得的新参数不应该小于上一个迭代的参数

- **[develope][ok] 开发不同速度的包络理论模型**
按照轮胎摩擦圆计算初始值,包括空气动力学,并且/50%

目前理论包络模型以及轮胎摩擦标定已经全部完成，下一步需要在线运行并更新

# 20251013
在线运行需要一个表征的gui显示系统状态，从 dynamics monitor 改装比较好，另一个方面就是包络扩展方式
有两种建模方式，分别是统计表达和动作表达。

统计表达就是直接用高分位数据进行表示。
动作表达就是把几个参数作为自由度，比较适合学习的方法，并且学习的过程中加入human的feedback

- **[upgrade][doing] GUI dynamics monitor升级**
1. 建立随着速度变化的极限滑移数值（尽量依据实车数据，也可以根据仿真数据）
读取标定文件，可以有估计模型的随着vx变化的ax-sx曲线，以及当前点在曲线上的位置(dynamic tire-road character)，确实包含了允许的slip极限
1. 车辆动作最好加入百分比描述，直接将cmd->fb panel集成进来，显示的数据也替换为fb值
2. 打通播包显示
3. 多模型轮胎力估计，方差显示，轮胎力显示，Fz Fx Fy,虚拟的mu，（大型更新）

- **[dev] 包络置信**
足够的行驶数据越多置信度越高
包络上状态点，先验极限利用率较低，置信度越高
两个需要进行归一化，然后再组成一个联合分布
每个速度循环分别执行

实验设计：
发动机以及空气阻力模型已知

1.开始使用理论模型E_t的保守因子为0.7的开始
E_t0.7->E_cur
2.开始采集数据
3.检查当前E_cur附近的ggvpoint的limit evaluation值，以及计算分区域的数量
纯加速减速转向工况（每个工况两个参数）a0只能越来越大不能越来越小
加速耦合工况 c_acc
减速耦合工况 c_dec
6 + 2 = 8
选择最自信的方向
每个方向从1.0～1.1，0.1的比例由置信度决定，置信度为0,更新为0,置信度>th（100）,更新为0.1。最小单位为0.005也就是20个离散动作
参考实车调试每步最大1.005

纯工况和耦合工况应该先后执行，这样可以减小很多整体难度，当然也可以进行适当的迭代

如果采集不到点那么说明无法达到或者不关键，就不进行更新了


